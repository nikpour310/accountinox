# ุฑุงูููุง ุชูุธู OTP ุจุง IPPanel Edge API

## ๐ ูุนุฑู

ุณุณุชู OTP (ฺฉุฏ ฺฉโุจุงุฑูุตุฑู) ุจุฑุง ูุฑูุฏ ู ุซุจุชโูุงู ุจุง ุดูุงุฑู ููุจุงู ุงุฒ **IPPanel Edge API** ุงุณุชูุงุฏู ูโฺฉูุฏ.
ฺฉุงุฑุจุฑุงู ูโุชูุงููุฏ ุจุฏูู ูุงุฒ ุจู ุงูู ู ุฑูุฒ ุนุจูุฑุ ุชููุง ุจุง ุดูุงุฑู ููุจุงู ุฎูุฏ ูุงุฑุฏ ุดููุฏ ุง ุซุจุชโูุงู ฺฉููุฏ.

## ๐๏ธ ูุนูุงุฑ ุณุณุชู

```
ฺฉุงุฑุจุฑ โ ุตูุญู OTP Login โ ุงุฑุณุงู ุดูุงุฑู โ ุณุฑูุฑ (Django)
                                           โ
                                    ุชููุฏ ฺฉุฏ 6 ุฑูู
                                           โ
                                   ุฐุฎุฑู HMAC ุฏุฑ ุฏุชุงุจุณ
                                           โ
                              ุงุฑุณุงู ูพุงูฺฉ ุจุง IPPanel Edge API
                                    (Pattern-based SMS)
                                           โ
                              ฺฉุงุฑุจุฑ ฺฉุฏ ุฑุง ูุงุฑุฏ ูโฺฉูุฏ
                                           โ
                               ุชุงุฏ โ ูุงฺฏู / ุซุจุชโูุงู ุฎูุฏฺฉุงุฑ
```

## ๐ ูพุดโูุงุฒูุง

1. ุญุณุงุจ ฺฉุงุฑุจุฑ ุฏุฑ [IPPanel](https://ippanel.com)
2. ุฏุณุชุฑุณ ุจู ูพูู ูุฏุฑุช IPPanel
3. ฺฉ **ุดูุงุฑู ุงุฎุชุตุงุต** (Originator) ุจุฑุง ุงุฑุณุงู ูพุงูฺฉ
4. ฺฉ **ูพุชุฑู ุชุงุฏ ุดุฏู** ุจุฑุง ุงุฑุณุงู OTP

---

## ๐ง ูุฑุญูู ฑ: ุงุฌุงุฏ API Key ุฏุฑ IPPanel

1. ูุงุฑุฏ ูพูู IPPanel ุดูุฏ
2. ุจู ุจุฎุด **ุชูุณุนูโุฏููุฏฺฏุงู** > **ฺฉูุฏูุง ุฏุณุชุฑุณ** ุจุฑูุฏ
3. ฺฉ API Key ุฌุฏุฏ ุจุณุงุฒุฏ
4. API Key ุฑุง ฺฉูพ ฺฉูุฏ (ุงู ฺฉูุฏ ูููุถ ููโุดูุฏ)

> โ๏ธ API Key ุฑุง ุฏุฑ ุฌุง ุงูู ูฺฏู ุฏุงุฑุฏ ู ูุฑฺฏุฒ ุฏุฑ ฺฉุฏ commit ูฺฉูุฏ.

---

## ๐ง ูุฑุญูู ฒ: ุงุฌุงุฏ ูพุชุฑู (Pattern) ูพุงูฺฉ

ูพุชุฑู ฺฉ ูุงูุจ ูพุงู ุงุฒ ูพุด ุชุงุฏ ุดุฏู ุงุณุช ฺฉู ุดุงูู ูุชุบุฑูุง ูโุจุงุดุฏ.

### ุงุฌุงุฏ ูพุชุฑู ุฏุฑ ูพูู IPPanel:

1. ุจู ุจุฎุด **ูพุชุฑูโูุง** ุจุฑูุฏ
2. ุฑู **ุงุฌุงุฏ ูพุชุฑู ุฌุฏุฏ** ฺฉูฺฉ ฺฉูุฏ
3. ุงุทูุงุนุงุช ุฒุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ:

| ููุฏ | ููุฏุงุฑ |
|------|-------|
| **ุนููุงู** | `OTP Verification` |
| **ุชูุถุญุงุช** | `ฺฉุฏ ุชุงุฏ ูุฑูุฏ/ุซุจุชโูุงู` |
| **ูุชู ูพุงู** | `ฺฉุฏ ุชุงุฏ ุดูุง: %verification-code%` |
| **ูุชุบุฑูุง** | `verification-code` (ููุน: `integer`) |

4. ูพุชุฑู ุฑุง ุซุจุช ฺฉูุฏ
5. ููุชุธุฑ **ุชุงุฏ** ูพุชุฑู ุชูุณุท ุชู IPPanel ุจุงุดุฏ (ูุนูููุงู ฺูุฏ ุณุงุนุช)
6. ูพุณ ุงุฒ ุชุงุฏุ **pattern_code** ุฑุง ุงุฒ ูุณุช ูพุชุฑูโูุง ฺฉูพ ฺฉูุฏ

### ุงุฌุงุฏ ูพุชุฑู ุจุง API:

```bash
curl -X POST 'https://edge.ippanel.com/v1/api/user/pattern' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: YOUR_API_KEY' \
  -d '{
    "title": "OTP Verification",
    "description": "ฺฉุฏ ุชุงุฏ ูุฑูุฏ/ุซุจุชโูุงู",
    "is_share": false,
    "message": "ฺฉุฏ ุชุงุฏ ุดูุง: %verification-code%",
    "website": "https://yourdomain.com",
    "variable": [
        {
            "name": "verification-code",
            "type": "integer"
        }
    ]
  }'
```

**ูพุงุณุฎ ูููู:**
```json
{
    "data": {
        "pattern_code": "abc123xyz",
        "pattern_status": "pending",
        ...
    }
}
```

> ๐ `pattern_code` ุฑุง ุงุฏุฏุงุดุช ฺฉูุฏ โ ุฏุฑ ุชูุธูุงุช ูพุฑูฺู ูุงุฒ ุฏุงุฑุฏ.

---

## ๐ง ูุฑุญูู ณ: ุชูุธู ูุชุบุฑูุง ูุญุท

ูุงู `.env` ุฑุง ุฏุฑ ุฑุดู ูพุฑูฺู ุจุงุฒ ฺฉูุฏ ู ููุงุฏุฑ ุฒุฑ ุฑุง ุชูุธู ฺฉูุฏ:

```dotenv
# IPPanel SMS Settings
IPPANEL_API_KEY=your-api-key-here
IPPANEL_ORIGINATOR=+983000505
IPPANEL_PATTERN_CODE=abc123xyz
```

| ูุชุบุฑ | ุชูุถุญ | ูุซุงู |
|--------|--------|------|
| `IPPANEL_API_KEY` | ฺฉูุฏ API ุงุฒ ูพูู IPPanel | `abcdef123456` |
| `IPPANEL_ORIGINATOR` | ุดูุงุฑู ุงุฑุณุงูโฺฉููุฏู | `+983000505` |
| `IPPANEL_PATTERN_CODE` | ฺฉุฏ ูพุชุฑู ุชุงุฏ ุดุฏู | `jhaskdab45s6f4sfw` |

---

## ๐ง ูุฑุญูู ด: ูุนุงูโุณุงุฒ ุฏุฑ ูพูู ุงุฏูู

1. ูุงุฑุฏ ูพูู ุงุฏูู Django ุดูุฏ: `http://yourdomain.com/admin/`
2. ุจู **ุชูุธูุงุช ุณุงุช** (Site Settings) ุจุฑูุฏ
3. ููุฏูุง ุฒุฑ ุฑุง ุชูุธู ฺฉูุฏ:

| ุชูุธู | ููุฏุงุฑ |
|--------|--------|
| **ุงุฑุณุงูโฺฉููุฏู SMS** | `IPPanel / Edge` |
| **ุงุฑุณุงู SMS ูุนุงู** | โ |
| **OTP ูุนุงู** | โ |
| **ูุฏุช ุงุนุชุจุงุฑ OTP** | `300` (ุซุงูู) |
| **ุญุฏุงฺฉุซุฑ ุชูุงุด OTP** | `5` |
| **ูุงุตูู ุงุฑุณุงู ูุฌุฏุฏ** | `60` (ุซุงูู) |

4. ุฐุฎุฑู ฺฉูุฏ

---

## ๐ง ูุฑุญูู ต (ูพุฑูุฏุงฺฉุดู): ุชูุธูุงุช ุงููุช

ุจุฑุง ูุญุท ูพุฑูุฏุงฺฉุดู ุญุชูุงู ููุงุฑุฏ ุฒุฑ ุฑุง ุชูุธู ฺฉูุฏ:

```dotenv
# ุงูุฒุงู ุฏุฑ ูพุฑูุฏุงฺฉุดู
OTP_HMAC_KEY=your-random-64-char-hex-string
FERNET_KEY=your-fernet-key

# ุชููุฏ OTP_HMAC_KEY:
# python -c "import secrets; print(secrets.token_hex(32))"

# ุชููุฏ FERNET_KEY:
# python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

---

## ๐งช ุชุณุช ุฏุฑ ูุญุท ุชูุณุนู

ุฏุฑ ูุญุท ุชูุณุนู (ุจุฏูู ุชูุธู IPPanel)ุ ุณุณุชู ุงุฒ **ConsoleProvider** ุงุณุชูุงุฏู ูโฺฉูุฏ ู ฺฉุฏ OTP ููุท ุฏุฑ ูุงฺฏ ููุงุด ุฏุงุฏู ูโุดูุฏ.

### ุชุณุช ุฏุณุช:

1. ุณุฑูุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:
   ```bash
   python manage.py runserver 8005
   ```

2. ุจู ุขุฏุฑุณ ุฒุฑ ุจุฑูุฏ:
   ```
   http://127.0.0.1:8005/accounts/otp/login/
   ```

3. ุดูุงุฑู ููุจุงู ูุงุฑุฏ ฺฉูุฏ (ูุซูุงู `09123456789`)

4. ุฏุฑ ุญุงูุช Consoleุ ฺฉุฏ ุฏุฑ ุชุฑููุงู ุณุฑูุฑ ฺุงูพ ูโุดูุฏ:
   ```
   INFO [SMS-Console] OTP sent to=09123456789 (code not logged for security)
   ```

> ๐ก **ูฺฉุชู:** ุฏุฑ ุญุงูุช Consoleุ ฺฉุฏ ูุงูุน ูุงฺฏ ููโุดูุฏ (ุงููุช). ุจุฑุง ุชุณุชุ ูโุชูุงูุฏ ุงุฒ ุฏุชุงุจุณ ูุณุชููุงู ุจุฑุฑุณ ฺฉูุฏ ุง SMS provider ุฑุง ุจู IPPanel ุชุบุฑ ุฏูุฏ.

### ุชุณุช ุจุง API:

```python
# ุฏุฑ Django shell
from apps.accounts.sms_providers import IPPanelProvider

provider = IPPanelProvider(
    api_key='YOUR_KEY',
    pattern_code='YOUR_PATTERN_CODE', 
    originator='+983000505'
)
result = provider.send_otp('09123456789', '123456')
print(result)  # True on success
```

---

## ๐ก ูุญูู ุงุฑุณุงู ูพุงูฺฉ (Edge API)

ุณุณุชู ุงุฒ endpoint ุฒุฑ ุจุฑุง ุงุฑุณุงู OTP ุงุณุชูุงุฏู ูโฺฉูุฏ:

```
POST https://edge.ippanel.com/v1/api/sms/pattern/normal/send
```

### ุจุฏูู ุฏุฑุฎูุงุณุช:
```json
{
    "pattern_code": "abc123xyz",
    "originator": "+983000505",
    "recipient": "09123456789",
    "values": {
        "verification-code": "123456"
    }
}
```

### ูุฏุฑูุง:
```
Content-Type: application/json
Authorization: YOUR_API_KEY
```

---

## ๐ ูฺฉุงุช ุงููุช

- **ฺฉุฏ OTP ูุฑฺฏุฒ ูุงฺฏ ููโุดูุฏ** โ ููุท ุดูุงุฑู ููุตุฏ ุซุจุช ูโุดูุฏ
- **HMAC-SHA256** ุจุฑุง ุฐุฎุฑู ฺฉุฏ ุงุณุชูุงุฏู ูโุดูุฏ (ูู plaintext)
- **Rate limiting** ุฑู endpoint ุงุฑุณุงู: ุญุฏุงฺฉุซุฑ ต ุฏุฑุฎูุงุณุช ุฏุฑ ุฏููู
- **Rate limiting** ุฑู endpoint ุชุงุฏ: ุญุฏุงฺฉุซุฑ ฑฐ ุฏุฑุฎูุงุณุช ุฏุฑ ุฏููู
- **ููู ุญุณุงุจ** ุจุนุฏ ุงุฒ ุชุนุฏุงุฏ ุชูุงุดโูุง ูุงูููู (ูพุดโูุฑุถ: ต ุจุงุฑ)
- **Cooldown** ุจู ุงุฑุณุงู ูุฌุฏุฏ (ูพุดโูุฑุถ: ถฐ ุซุงูู)
- **ุงููุถุง ฺฉุฏ** (ูพุดโูุฑุถ: ณฐฐ ุซุงูู = ต ุฏููู)
- ูุฑูุช ุดูุงุฑู ููุจุงู ุงุนุชุจุงุฑุณูุฌ ูโุดูุฏ: `09XXXXXXXXX`

---

## ๐ URLูุง

| ูุณุฑ | ุชูุถุญ |
|-------|--------|
| `/accounts/otp/login/` | ุตูุญู ูุฑูุฏ/ุซุจุชโูุงู ุจุง OTP |
| `/accounts/otp/send/` | API ุงุฑุณุงู ฺฉุฏ (POST) |
| `/accounts/otp/verify/` | API ุชุงุฏ ฺฉุฏ (POST) |
| `/accounts/otp/verify-login/` | API ุชุงุฏ + ูุงฺฏู (POST) |

---

## ๐๏ธ ุนุจโุงุจ

### ูุดฺฉู: ูพุงูฺฉ ุงุฑุณุงู ููโุดูุฏ

1. ุจุฑุฑุณ ฺฉูุฏ `IPPANEL_API_KEY` ุฏุฑุณุช ุชูุธู ุดุฏู
2. ุจุฑุฑุณ ฺฉูุฏ ูพุชุฑู **ุชุงุฏ ุดุฏู** ุจุงุดุฏ (status: approved)
3. ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ: `logs/django_info.log`
4. ุฏุฑ ุงุฏููุ SMS provider ุฑู `ippanel` ุชูุธู ุดุฏู ุจุงุดุฏ

### ูุดฺฉู: ุฎุทุง "OTP disabled"

OTP ุงุฒ ูพูู ุงุฏูู (Site Settings) ุบุฑูุนุงู ุดุฏู. ูุนุงูุด ฺฉูุฏ.

### ูุดฺฉู: ุฎุทุง "cooldown"

ฺฉุงุฑุจุฑ ุจุงุฏ ถฐ ุซุงูู (ุง ููุฏุงุฑ ุชูุธู ุดุฏู) ุตุจุฑ ฺฉูุฏ ูุจู ุงุฒ ุงุฑุณุงู ูุฌุฏุฏ.

### ูุดฺฉู: ุฎุทุง "locked"

ุชุนุฏุงุฏ ุชูุงุดโูุง ุจู ุญุฏุงฺฉุซุฑ ุฑุณุฏู. ุญุณุงุจ ุจุฑุง ูุฏุช ููู ูโุดูุฏ.

---

## ๐ ูุณุชูุฏุงุช ูุฑุชุจุท

- [ูุณุชูุฏุงุช Edge API - IPPanel](https://ippanelcom.github.io/Edge-Document/docs/)
- [ูุฏุฑุช ูพุชุฑูโูุง](https://ippanelcom.github.io/Edge-Document/docs/pattern/)
- [ุงุฑุณุงู ูพุงูฺฉ ูพุชุฑู](https://ippanelcom.github.io/Edge-Document/docs/send/pattern)
- [ุฏุงฺฉูููุช ูุจู OTP ูพุฑูฺู](./OTP_IPPANEL.md)
