{% extends 'base.html' %}

{% block title %}امتیازدهی پشتیبانی{% endblock %}
{% block meta_title %}امتیازدهی پشتیبانی | {{ site_settings.site_name|default:'Accountinox' }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block content %}
<section class="mx-auto max-w-2xl py-6 sm:py-10">
  <div class="card p-4 sm:p-6">
    <h1 class="text-2xl font-bold text-gray-900 mb-2">امتیازدهی به پشتیبانی</h1>
    <p class="text-sm text-gray-600 mb-5">
      گفتگوی شماره #{{ session.id }}
      {% if agent %}
        | اپراتور: {{ agent.get_full_name|default:agent.username }}
      {% endif %}
    </p>

    {% if existing_rating %}
      <div class="alert alert-success">
        امتیاز شما قبلاً ثبت شده است: {{ existing_rating.score }} از 5
        {% if existing_rating.reason %}
          <p class="mt-2 text-xs text-gray-700">دلیل: {{ existing_rating.reason }}</p>
        {% endif %}
      </div>
      <div class="mt-4 flex justify-end">
        <a href="{% url 'support:chat' %}" class="btn btn-primary w-full sm:w-auto">بازگشت به پشتیبانی</a>
      </div>
    {% else %}
      <form method="post" class="space-y-4">
        {% csrf_token %}
        <div>
          <label for="score" class="block text-sm font-medium text-gray-700 mb-1">امتیاز (1 تا 5)</label>
          <select id="score" name="score" class="form-input" required>
            <option value="">انتخاب امتیاز</option>
            {% for score in "12345" %}
              <option value="{{ score }}" {% if form_score|stringformat:"s" == score %}selected{% endif %}>{{ score }}</option>
            {% endfor %}
          </select>
          {% if rating_errors.score %}
            <p class="mt-1 text-sm text-red-600">{{ rating_errors.score }}</p>
          {% endif %}
        </div>

        <div>
          <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">
            دلیل (برای امتیاز 1 الزامی)
          </label>
          <textarea
            id="reason"
            name="reason"
            rows="4"
            maxlength="1000"
            class="form-input"
            placeholder="توضیح کوتاه درباره تجربه شما..."
          >{{ form_reason }}</textarea>
          {% if rating_errors.reason %}
            <p class="mt-1 text-sm text-red-600">{{ rating_errors.reason }}</p>
          {% endif %}
        </div>

        <div class="flex justify-end gap-2">
          <a href="{% url 'support:chat' %}" class="btn btn-ghost w-full sm:w-auto">انصراف</a>
          <button type="submit" class="btn btn-primary w-full sm:w-auto">ثبت امتیاز</button>
        </div>
      </form>
    {% endif %}
  </div>
</section>
{% endblock %}
