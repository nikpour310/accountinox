{% extends 'base.html' %}
{% load seo_tags %}

{% block title %}گفت‌وگوی پشتیبانی #{{ session.id }}{% endblock %}
{% block meta_robots %}
<meta name="robots" content="noindex,nofollow">
{% endblock %}

{% block content %}
<div class="page-wrapper max-w-7xl">
  <div class="mb-6 flex flex-wrap items-center justify-between gap-4 reveal">
    <div>
      <h1 class="section-title">گفت‌وگوی پشتیبانی</h1>
      <p class="section-subtitle mt-1">
        {% if session.contact %}
          {{ session.contact.name }} - {{ session.contact.phone }}
        {% elif session.user_phone %}
          {{ session.user_name|default:'کاربر' }} - {{ session.user_phone }}
        {% else %}
          {{ session.user_name|default:session.user|default:'کاربر ناشناس' }}
        {% endif %}
        | کد گفتگو: #{{ session.id }}
      </p>
      <p class="mt-2 text-xs text-gray-500">
        SLA فوری: {{ queue_summary.sla_warning_minutes }} دقیقه | SLA بحرانی: {{ queue_summary.sla_breach_minutes }} دقیقه
      </p>
      {% if rate_limited %}
        <p class="mt-2 text-sm text-red-600">ارسال پیام موقتاً محدود شده است. کمی بعد دوباره تلاش کنید.</p>
      {% endif %}
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <label class="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-600">
        <input id="sound-toggle" type="checkbox" class="h-4 w-4 rounded border-gray-300">
        <span>صدای اعلان</span>
      </label>
      <a href="{% url 'support:operator_dashboard' %}" class="btn btn-ghost btn-sm">بازگشت به داشبورد</a>
      <a href="{% url 'support:close_session' session.id %}" class="btn btn-soft btn-sm text-red-600" onclick="return confirm('گفتگو بسته شود؟');">بستن گفتگو</a>
    </div>
  </div>

  <div id="unread-banner" class="alert alert-warning mb-5 {% if unread_count == 0 %}hidden{% endif %} reveal">
    <span id="unread-count" class="font-semibold">{{ unread_count }}</span>
    <span> پیام خوانده‌نشده در گفتگوهای فعال وجود دارد.</span>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-5 reveal">
    <aside class="lg:col-span-4 xl:col-span-3">
      <div class="card overflow-hidden">
        <div class="border-b border-gray-100 bg-gray-50/60 px-4 py-3">
          <h2 class="text-sm font-semibold text-gray-900">گفتگوهای فعال</h2>
        </div>
        <div class="max-h-[65vh] overflow-y-auto divide-y divide-gray-100">
          {% for active in active_sessions %}
            <a
              href="{% url 'support:operator_session' active.id %}"
              class="block px-4 py-3 transition-colors {% if active.id == session.id %}bg-primary-50{% else %}hover:bg-gray-50/60{% endif %}"
            >
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <p class="truncate text-sm font-semibold text-gray-900">
                    {% if active.contact %}{{ active.contact.name }}{% else %}{{ active.user_name|default:active.user }}{% endif %}
                  </p>
                  <p class="mt-1 truncate text-[11px] text-gray-500">
                    {% if active.contact %}
                      {{ active.contact.phone }}
                    {% elif active.user_phone %}
                      {{ active.user_phone }}
                    {% else %}
                      شماره ثبت نشده
                    {% endif %}
                  </p>
                  <div class="mt-2 flex flex-wrap items-center gap-1.5">
                    <span class="chip text-[10px] {{ active.priority_badge_class }}">{{ active.priority_label }}</span>
                    <span class="chip text-[10px] {{ active.sla_badge_class }}">{{ active.sla_label }}</span>
                  </div>
                </div>
                {% if active.unread_count %}
                  <span class="inline-flex h-5 min-w-5 items-center justify-center rounded-full bg-red-500 px-1.5 text-[11px] font-bold text-white">
                    {{ active.unread_count }}
                  </span>
                {% endif %}
              </div>
              <p class="mt-2 text-[10px] text-gray-400">انتظار: {{ active.wait_duration }}</p>
            </a>
          {% empty %}
            <div class="px-4 py-10 text-center text-sm text-gray-400">گفتگوی فعالی وجود ندارد.</div>
          {% endfor %}
        </div>
      </div>
    </aside>

    <div class="lg:col-span-8 xl:col-span-9">
      <div class="card-elevated overflow-hidden">
        <div id="operator-messages" class="h-[58vh] sm:h-[30rem] overflow-y-auto bg-gray-50/60 p-4 sm:p-6 space-y-3">
          {% for message in messages %}
            <div class="flex {% if message.is_from_user %}justify-start{% else %}justify-end{% endif %}" data-message-id="{{ message.id }}">
              <div class="max-w-[85%] sm:max-w-[74%]">
                <p class="mb-1 text-[11px] text-gray-400 {% if message.is_from_user %}text-right{% else %}text-left{% endif %}">
                  {{ message.name }} - {{ message.created_at|date:'H:i' }}
                </p>
                <div class="rounded-2xl px-4 py-2.5 text-sm leading-relaxed break-words shadow-sm {% if message.is_from_user %}bg-white border border-gray-200 text-gray-900 rounded-bl-sm{% else %}bg-primary-600 text-white rounded-br-sm{% endif %}">
                  {{ message.message }}
                </div>
              </div>
            </div>
          {% empty %}
            <div id="empty-thread" class="py-16 text-center text-sm text-gray-400">هنوز پیامی ثبت نشده است.</div>
          {% endfor %}
        </div>

        <div class="divider"></div>

        <div class="bg-white p-4 sm:p-5">
          <form id="operator-reply-form" method="post" action="{% url 'support:operator_send_message' %}" class="space-y-3">
            {% csrf_token %}
            <input type="hidden" name="session_id" value="{{ session.id }}">
            {% if quick_replies %}
              <div class="rounded-xl border border-gray-100 bg-gray-50/70 p-3">
                <p class="mb-2 text-xs font-semibold text-gray-700">پاسخ‌های آماده</p>
                <div class="flex flex-wrap gap-2">
                  {% for reply in quick_replies %}
                    <button
                      type="button"
                      class="quick-reply-btn btn btn-ghost btn-sm !h-8 !px-3 !text-xs"
                      data-quick-reply="{{ reply.text|escapejs }}"
                    >
                      {{ reply.label }}
                    </button>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            <textarea
              id="operator-message-input"
              name="message"
              rows="3"
              maxlength="1000"
              class="form-input"
              placeholder="پاسخ اپراتور را بنویسید..."
              required
            ></textarea>
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="space-y-1">
                <p id="send-status" class="text-xs text-gray-400">ارسال پاسخ بدون ترک صفحه انجام می‌شود.</p>
                <p id="user-typing-indicator" class="hidden text-xs text-amber-600">کاربر در حال نوشتن پیام است...</p>
              </div>
              <button id="operator-send-btn" type="submit" class="btn btn-primary w-full sm:w-auto">ارسال پاسخ</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-5 overflow-hidden">
        <div class="border-b border-gray-100 bg-gray-50/60 px-4 py-3">
          <h2 class="text-sm font-semibold text-gray-900">تاریخچه عملیات گفتگو</h2>
        </div>
        <div class="divide-y divide-gray-100">
          {% for log in audit_logs %}
            <div class="px-4 py-3">
              <div class="flex items-center justify-between gap-2">
                <p class="text-sm font-medium text-gray-900">{{ log.action_label }}</p>
                <p class="text-[11px] text-gray-400">{{ log.created_at|jdate:'Y/m/d H:i' }}</p>
              </div>
              <p class="mt-1 text-xs text-gray-500">توسط: {{ log.actor_label }}</p>
            </div>
          {% empty %}
            <div class="px-4 py-8 text-center text-sm text-gray-400">برای این گفتگو هنوز سابقه‌ای ثبت نشده است.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const messagesContainer = document.getElementById('operator-messages');
    const form = document.getElementById('operator-reply-form');
    const messageInput = document.getElementById('operator-message-input');
    const sendBtn = document.getElementById('operator-send-btn');
    const sendStatus = document.getElementById('send-status');
    const unreadBanner = document.getElementById('unread-banner');
    const unreadCountEl = document.getElementById('unread-count');
    const soundToggle = document.getElementById('sound-toggle');
    const emptyThread = document.getElementById('empty-thread');
    const sessionId = {{ session.id }};
    const unreadStatusUrl = '{% url "support:operator_unread_status" %}?session_id={{ session.id }}';
    const presenceUrl = '{% url "support:operator_presence" %}?session_id={{ session.id }}';
    const pollUrl = '{% url "support:poll_messages" %}';
    const typingUpdateUrl = '{% url "support:typing_update" %}';
    const typingStatusUrl = '{% url "support:typing_status" %}?session_id={{ session.id }}';
    const storageKey = 'support_operator_sound_enabled';
    const quickReplyButtons = document.querySelectorAll('.quick-reply-btn');
    const userTypingIndicator = document.getElementById('user-typing-indicator');
    const csrfInput = form ? form.querySelector('input[name="csrfmiddlewaretoken"]') : null;
    const csrfToken = csrfInput ? csrfInput.value : '';
    let lastMessageId = Number('{{ last_message_id|default:0 }}');
    let unreadCount = Number('{{ unread_count|default:0 }}');
    let polling = false;
    const renderedMessageIds = new Set();
    let typingStatusInFlight = false;
    let typingResetTimer = null;
    let operatorTypingSent = false;

    const savedState = localStorage.getItem(storageKey);
    soundToggle.checked = savedState === null ? true : savedState === '1';
    soundToggle.addEventListener('change', () => {
      localStorage.setItem(storageKey, soundToggle.checked ? '1' : '0');
    });

    const shouldPlaySound = () => soundToggle.checked && (document.hidden || !document.hasFocus());

    const playAlertSound = () => {
      if (!shouldPlaySound()) {
        return;
      }
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 920;
        gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.24, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.2);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.22);
      } catch (_) {}
    };

    const setSendStatus = (text, tone = 'muted') => {
      if (!sendStatus) {
        return;
      }
      sendStatus.textContent = text;
      sendStatus.classList.remove('text-gray-400', 'text-red-600', 'text-emerald-600');
      if (tone === 'error') {
        sendStatus.classList.add('text-red-600');
      } else if (tone === 'success') {
        sendStatus.classList.add('text-emerald-600');
      } else {
        sendStatus.classList.add('text-gray-400');
      }
    };

    const setUserTypingIndicator = (isTyping) => {
      if (!userTypingIndicator) {
        return;
      }
      userTypingIndicator.classList.toggle('hidden', !isTyping);
    };

    const updateOperatorTypingState = async (isTyping, force = false) => {
      if (!csrfToken) {
        return;
      }
      if (!force && operatorTypingSent === Boolean(isTyping)) {
        return;
      }
      operatorTypingSent = Boolean(isTyping);
      try {
        const payload = new URLSearchParams();
        payload.append('session_id', String(sessionId));
        payload.append('is_typing', isTyping ? '1' : '0');
        await fetch(typingUpdateUrl, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: payload,
        });
      } catch (_) {}
    };

    const updateUnreadUi = (count) => {
      unreadCount = Number(count || 0);
      if (unreadCountEl) {
        unreadCountEl.textContent = unreadCount;
      }
      if (!unreadBanner) {
        return;
      }
      unreadBanner.classList.toggle('hidden', unreadCount <= 0);
    };

    const refreshTypingStatus = async () => {
      if (typingStatusInFlight) {
        return;
      }
      typingStatusInFlight = true;
      try {
        const response = await fetch(typingStatusUrl, { credentials: 'same-origin' });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        setUserTypingIndicator(Boolean(data.user_typing));
      } catch (_) {
      } finally {
        typingStatusInFlight = false;
      }
    };

    const appendMessage = (message) => {
      const messageId = Number(message && message.id ? message.id : 0);
      if (messageId > 0 && renderedMessageIds.has(messageId)) {
        lastMessageId = Math.max(lastMessageId, messageId);
        return false;
      }
      if (emptyThread) {
        emptyThread.remove();
      }
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${message.is_from_user ? 'justify-start' : 'justify-end'}`;
      if (messageId > 0) {
        wrapper.dataset.messageId = String(messageId);
        renderedMessageIds.add(messageId);
      }

      const bubbleWrap = document.createElement('div');
      bubbleWrap.className = 'max-w-[85%] sm:max-w-[74%]';

      const meta = document.createElement('p');
      meta.className = 'mb-1 text-[11px] text-gray-400';
      meta.style.textAlign = message.is_from_user ? 'right' : 'left';
      const formattedTime = new Date(message.created_at).toLocaleTimeString('fa-IR', {
        hour: '2-digit',
        minute: '2-digit',
      });
      meta.textContent = `${message.name || 'اپراتور'} - ${formattedTime}`;

      const bubble = document.createElement('div');
      bubble.className = `rounded-2xl px-4 py-2.5 text-sm leading-relaxed break-words shadow-sm ${
        message.is_from_user
          ? 'bg-white border border-gray-200 text-gray-900 rounded-bl-sm'
          : 'bg-primary-600 text-white rounded-br-sm'
      }`;
      bubble.textContent = message.message || '';

      bubbleWrap.appendChild(meta);
      bubbleWrap.appendChild(bubble);
      wrapper.appendChild(bubbleWrap);
      messagesContainer.appendChild(wrapper);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return true;
    };

    const refreshUnreadStatus = async () => {
      try {
        const response = await fetch(unreadStatusUrl, { credentials: 'same-origin' });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        const nextCount = Number(data.unread_count || 0);
        if (nextCount > unreadCount) {
          playAlertSound();
        }
        updateUnreadUi(nextCount);
      } catch (_) {}
    };

    const heartbeat = async () => {
      try {
        await fetch(presenceUrl, { credentials: 'same-origin' });
      } catch (_) {}
    };

    const pollMessages = async () => {
      if (polling) {
        window.setTimeout(pollMessages, 2000);
        return;
      }
      polling = true;
      try {
        const response = await fetch(
          `${pollUrl}?thread_id=${sessionId}&since=${lastMessageId}&timeout=6`,
          { credentials: 'same-origin' }
        );
        if (!response.ok) {
          throw new Error('poll failed');
        }
        const data = await response.json();
        if (Array.isArray(data.messages) && data.messages.length > 0) {
          data.messages.forEach((msg) => {
            const appended = appendMessage(msg);
            lastMessageId = Math.max(lastMessageId, Number(msg.id || 0));
            if (appended && msg.is_from_user) {
              playAlertSound();
            }
          });
          await refreshUnreadStatus();
        }
        await refreshTypingStatus();
      } catch (_) {
      } finally {
        polling = false;
        window.setTimeout(pollMessages, 2000);
      }
    };

    quickReplyButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const quickReplyText = (button.getAttribute('data-quick-reply') || '').trim();
        if (!quickReplyText) {
          return;
        }
        const currentValue = (messageInput.value || '').trim();
        messageInput.value = currentValue ? `${currentValue}\n${quickReplyText}` : quickReplyText;
        messageInput.focus();
        messageInput.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });

    messageInput.addEventListener('input', () => {
      const hasText = Boolean((messageInput.value || '').trim());
      if (hasText) {
        updateOperatorTypingState(true);
        if (typingResetTimer) {
          clearTimeout(typingResetTimer);
        }
        typingResetTimer = window.setTimeout(() => {
          updateOperatorTypingState(false);
        }, 2800);
      } else {
        if (typingResetTimer) {
          clearTimeout(typingResetTimer);
          typingResetTimer = null;
        }
        updateOperatorTypingState(false);
      }
    });

    messageInput.addEventListener('blur', () => {
      if (typingResetTimer) {
        clearTimeout(typingResetTimer);
        typingResetTimer = null;
      }
      updateOperatorTypingState(false, true);
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (sendBtn.disabled) {
        return;
      }
      const text = messageInput.value.trim();
      if (!text) {
        return;
      }
      sendBtn.disabled = true;
      if (typingResetTimer) {
        clearTimeout(typingResetTimer);
        typingResetTimer = null;
      }
      await updateOperatorTypingState(false, true);
      sendBtn.disabled = true;
      setSendStatus('در حال ارسال پاسخ...');
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: new FormData(form),
          credentials: 'same-origin',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
          },
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data.ok) {
          if (response.status === 429) {
            setSendStatus('ارسال شما محدود شده است. کمی بعد تلاش کنید.', 'error');
            return;
          }
          throw new Error(data.error || 'send failed');
        }
        appendMessage({
          id: data.message_id,
          name: data.name || 'اپراتور',
          message: data.message,
          is_from_user: false,
          created_at: data.created_at,
        });
        lastMessageId = Math.max(lastMessageId, Number(data.message_id || 0));
        messageInput.value = '';
        setSendStatus('✅ پیام ارسال شد.', 'success');
        await refreshUnreadStatus();
      } catch (_) {
        setSendStatus('ارسال پاسخ انجام نشد. دوباره تلاش کنید.', 'error');
      } finally {
        sendBtn.disabled = false;
        await updateOperatorTypingState(false, true);
      }
    });

    messagesContainer.querySelectorAll('[data-message-id]').forEach((node) => {
      const messageId = Number(node.getAttribute('data-message-id') || 0);
      if (messageId > 0) {
        renderedMessageIds.add(messageId);
      }
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    heartbeat();
    refreshUnreadStatus();
    refreshTypingStatus();
    window.setInterval(heartbeat, 60000);
    window.setInterval(refreshUnreadStatus, 7000);
    window.setInterval(refreshTypingStatus, 2500);
    window.setTimeout(pollMessages, 1200);
  });
</script>
{% endblock %}
