{% extends 'base.html' %}
{% load seo_tags %}

{% block title %}داشبورد اپراتور پشتیبانی{% endblock %}
{% block meta_robots %}
<meta name="robots" content="noindex,nofollow">
{% endblock %}

{% block content %}
<div class="page-wrapper max-w-5xl">
  <div class="mb-8 grid grid-cols-1 lg:grid-cols-3 gap-5 reveal">
    <div class="lg:col-span-2">
      <h1 class="section-title">داشبورد اپراتور</h1>
      <p class="section-subtitle mt-1">مدیریت گفتگوهای فعال و پاسخ‌گویی سریع</p>
      {% if rate_limited %}
        <p class="mt-2 text-sm text-red-600">ارسال پیام محدود شده است. کمی بعد دوباره تلاش کنید.</p>
      {% endif %}
    </div>

    <div class="card p-4 sm:p-5 text-right">
      <form id="push-csrf-form" class="hidden">{% csrf_token %}</form>
      <div class="flex items-center justify-between mb-3">
        <p class="text-sm font-semibold text-gray-800">اعلان‌ها</p>
        <label class="inline-flex items-center gap-2 text-xs text-gray-600">
          <input id="sound-toggle" type="checkbox" class="h-4 w-4 rounded border-gray-300">
          <span>صدای اعلان</span>
        </label>
      </div>
      <button id="push-enable-btn" type="button" class="btn btn-primary btn-sm w-full">فعال‌سازی اعلان مرورگر</button>
      <p id="push-status" class="mt-2 text-xs text-gray-500">اعلان مرورگر غیرفعال است.</p>
      <p id="fallback-status" class="mt-1 text-xs text-amber-600 hidden">fallback polling فعال است.</p>
    </div>
  </div>

  <div id="unread-banner" class="alert alert-warning mb-6 {% if unread_count == 0 %}hidden{% endif %} reveal">
    <span id="unread-count" class="font-semibold">{{ unread_count }}</span>
    <span> پیام خوانده‌نشده در گفتگوهای فعال وجود دارد.</span>
  </div>

  <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6 reveal">
    <div class="card p-4">
      <p class="text-xs text-gray-500">کل گفتگوهای فعال</p>
      <p class="mt-1 text-xl font-bold text-gray-900">{{ queue_summary.total_active }}</p>
    </div>
    <div class="card p-4">
      <p class="text-xs text-gray-500">نیازمند پاسخ</p>
      <p class="mt-1 text-xl font-bold text-amber-700">{{ queue_summary.need_reply }}</p>
    </div>
    <div class="card p-4">
      <p class="text-xs text-gray-500">موارد بحرانی</p>
      <p class="mt-1 text-xl font-bold text-red-700">{{ queue_summary.critical }}</p>
    </div>
    <div class="card p-4">
      <p class="text-xs text-gray-500">ارجاع به من</p>
      <p class="mt-1 text-xl font-bold text-primary-700">{{ queue_summary.mine }}</p>
    </div>
    <div class="card p-4">
      <p class="text-xs text-gray-500">میانگین انتظار</p>
      <p class="mt-1 text-xl font-bold text-gray-900">{{ queue_summary.avg_wait_minutes }} <span class="text-sm font-medium">دقیقه</span></p>
    </div>
  </div>
  <div class="mb-5 text-xs text-gray-500 reveal">
    SLA فوری از {{ queue_summary.sla_warning_minutes }} دقیقه و SLA بحرانی از {{ queue_summary.sla_breach_minutes }} دقیقه محاسبه می‌شود.
  </div>

  <div class="card p-4 sm:p-5 mb-5 reveal">
    <form method="get" class="space-y-3">
      <div class="flex flex-wrap gap-2">
        {% for key, label in queue_filters %}
          <a
            href="?status={{ key }}&sort={{ queue_sort }}{% if queue_query %}&q={{ queue_query|urlencode }}{% endif %}"
            class="chip text-xs {% if queue_filter == key %}bg-primary-50 text-primary-700{% else %}bg-gray-100 text-gray-700{% endif %}"
          >
            {{ label }}
          </a>
        {% endfor %}
      </div>
      <div class="flex flex-col sm:flex-row gap-2">
        <input
          type="text"
          name="q"
          value="{{ queue_query }}"
          class="form-input !h-10 !py-2 !text-sm"
          placeholder="جستجو (شماره تیکت/نام/شماره/موضوع)"
        >
        <select name="sort" class="form-input !h-10 !py-2 !text-sm sm:w-52">
          {% for key, label in queue_sorts %}
            <option value="{{ key }}"{% if queue_sort == key %} selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="status" value="{{ queue_filter }}">
        <button type="submit" class="btn btn-ghost btn-sm">اعمال</button>
      </div>
    </form>
  </div>

  <div class="card overflow-hidden reveal">
    <div class="border-b border-gray-100 bg-gray-50/60 px-5 py-3.5 flex items-center justify-between">
      <h2 class="text-sm font-semibold text-gray-900">صف گفتگوها</h2>
      <span class="text-xs text-gray-500">{{ active_sessions|length }} مورد</span>
    </div>
    <div class="divide-y divide-gray-100">
      {% for session in active_sessions %}
        <a href="{% url 'support:operator_session' session.id %}" class="block px-5 py-4 hover:bg-gray-50/60 transition-colors">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
            <div class="min-w-0">
              <p class="font-semibold text-gray-900 truncate">
                {% if session.contact %}{{ session.contact.name }}{% else %}{{ session.user_name|default:session.user }}{% endif %}
              </p>
              <p class="text-xs text-gray-500 mt-1 truncate">
                {% if session.contact %}
                  {{ session.contact.phone }}
                {% elif session.user_phone %}
                  {{ session.user_phone }}
                {% else %}
                  شماره ثبت نشده
                {% endif %}
                | {{ session.subject|default:'گفتگوی پشتیبانی' }}
              </p>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="chip text-xs {{ session.priority_badge_class }}">{{ session.priority_label }}</span>
                <span class="chip text-xs {{ session.sla_badge_class }}">{{ session.sla_label }}</span>
                <span class="chip text-xs {{ session.assignment_badge_class }}">{{ session.assignment_label }}</span>
              </div>
              <p class="text-[11px] text-gray-400 mt-2">
                {{ session.last_message_at|default:session.created_at|jdate:"Y/m/d H:i" }}
                | انتظار: {{ session.wait_duration }}
              </p>
              <p class="text-[11px] mt-1 {{ session.last_side_class }}">{{ session.last_side_label }}</p>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              {% if session.unread_count %}
                <span class="inline-flex h-5 min-w-5 px-1.5 items-center justify-center rounded-full bg-red-500 text-white text-[11px] font-bold">
                  {{ session.unread_count }}
                </span>
              {% endif %}
              <span class="text-xs text-primary-600 font-medium">مشاهده</span>
            </div>
          </div>
        </a>
      {% empty %}
        <div class="px-5 py-12 text-center text-sm text-gray-400">گفتگویی با این فیلتر پیدا نشد.</div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const unreadBanner = document.getElementById('unread-banner');
    const unreadCountEl = document.getElementById('unread-count');
    const pushEnableBtn = document.getElementById('push-enable-btn');
    const pushStatusEl = document.getElementById('push-status');
    const fallbackStatusEl = document.getElementById('fallback-status');
    const soundToggle = document.getElementById('sound-toggle');
    const pushSupportedByServer = {{ support_push_enabled|yesno:"true,false" }};
    const vapidPublicKey = '{{ support_push_public_key|escapejs }}';
    const subscribeUrl = '{% url "support:push_subscribe" %}';
    const unreadStatusUrl = '{% url "support:operator_unread_status" %}';
    const presenceUrl = '{% url "support:operator_presence" %}';
    const initialQueueSignature = '{{ operator_queue_signature|default:""|escapejs }}';
    const csrfTokenInput = document.querySelector('#push-csrf-form input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';
    let unreadCount = Number(unreadCountEl ? unreadCountEl.textContent : 0);
    let queueSignature = initialQueueSignature;
    let fallbackTimer = null;
    let isAutoReloading = false;

    const storageKey = 'support_operator_sound_enabled';
    const storedSoundState = localStorage.getItem(storageKey);
    const soundEnabled = storedSoundState === null ? true : storedSoundState === '1';
    soundToggle.checked = soundEnabled;

    soundToggle.addEventListener('change', () => {
      localStorage.setItem(storageKey, soundToggle.checked ? '1' : '0');
    });

    const shouldPlaySound = () => soundToggle.checked && (document.hidden || !document.hasFocus());

    const playAlertSound = () => {
      if (!shouldPlaySound()) {
        return;
      }
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 880;
        gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.22, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.22);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.24);
      } catch (_) {}
    };

    const updateUnreadUi = (count) => {
      unreadCount = Number(count || 0);
      if (unreadCountEl) {
        unreadCountEl.textContent = unreadCount;
      }
      if (!unreadBanner) {
        return;
      }
      if (unreadCount > 0) {
        unreadBanner.classList.remove('hidden');
      } else {
        unreadBanner.classList.add('hidden');
      }
    };

    const setPushStatus = (text, tone = 'muted') => {
      if (!pushStatusEl) {
        return;
      }
      pushStatusEl.textContent = text;
      pushStatusEl.classList.remove('text-gray-500', 'text-red-600', 'text-emerald-600');
      if (tone === 'error') {
        pushStatusEl.classList.add('text-red-600');
      } else if (tone === 'success') {
        pushStatusEl.classList.add('text-emerald-600');
      } else {
        pushStatusEl.classList.add('text-gray-500');
      }
    };

    const heartbeat = async () => {
      try {
        await fetch(presenceUrl, { credentials: 'same-origin' });
      } catch (_) {}
    };

    const triggerAutoRefresh = () => {
      if (isAutoReloading) {
        return;
      }
      isAutoReloading = true;
      window.setTimeout(() => {
        window.location.reload();
      }, 120);
    };

    const startFallbackPolling = () => {
      if (fallbackStatusEl) {
        fallbackStatusEl.classList.remove('hidden');
      }
      if (fallbackTimer) {
        return;
      }
      fallbackTimer = window.setInterval(async () => {
        try {
          const pollUrl = `${unreadStatusUrl}${unreadStatusUrl.includes('?') ? '&' : '?'}_ts=${Date.now()}`;
          const response = await fetch(pollUrl, {
            credentials: 'same-origin',
            cache: 'no-store',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
          });
          if (!response.ok) {
            return;
          }
          const data = await response.json();
          const nextUnread = Number(data.unread_count || 0);
          const nextQueueSignature = String(data.queue_signature || '');
          if (nextUnread > unreadCount) {
            playAlertSound();
          }
          updateUnreadUi(nextUnread);
          if (nextQueueSignature && queueSignature && nextQueueSignature !== queueSignature) {
            queueSignature = nextQueueSignature;
            triggerAutoRefresh();
            return;
          }
          if (nextQueueSignature) {
            queueSignature = nextQueueSignature;
          }
        } catch (_) {}
      }, 5000);
    };

    const stopFallbackPolling = () => {
      if (fallbackStatusEl) {
        fallbackStatusEl.classList.add('hidden');
      }
      if (fallbackTimer) {
        clearInterval(fallbackTimer);
        fallbackTimer = null;
      }
    };

    const urlBase64ToUint8Array = (base64String) => {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    };

    const enablePushNotifications = async () => {
      if (!pushSupportedByServer || !vapidPublicKey) {
        setPushStatus('Push در تنظیمات سرور فعال نیست. fallback فعال شد.', 'error');
        startFallbackPolling();
        return;
      }
      if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
        setPushStatus('مرورگر از Push پشتیبانی نمی‌کند. fallback فعال شد.', 'error');
        startFallbackPolling();
        return;
      }
      try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          setPushStatus('اجازه اعلان داده نشد. fallback فعال شد.', 'error');
          startFallbackPolling();
          return;
        }

        const registration = await navigator.serviceWorker.register('/sw.js');
        let subscription = await registration.pushManager.getSubscription();
        if (!subscription) {
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
          });
        }

        const response = await fetch(subscribeUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          credentials: 'same-origin',
          body: JSON.stringify({ ...subscription.toJSON(), active_session_id: null }),
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data.ok) {
          throw new Error('subscribe failed');
        }
        setPushStatus(`✅ اعلان‌ها فعال شد (اشتراک فعال: ${Number(data.active_subs || 0)})`, 'success');
        if (pushEnableBtn) {
          pushEnableBtn.textContent = 'اعلان‌ها فعال شد';
        }
        stopFallbackPolling();
      } catch (_) {
        setPushStatus('فعالسازی Push موفق نبود. fallback فعال شد.', 'error');
        startFallbackPolling();
      }
    };

    if (pushEnableBtn) {
      pushEnableBtn.addEventListener('click', enablePushNotifications);
    }

    if (window.Notification && Notification.permission === 'granted') {
      setPushStatus('اعلان مرورگر قبلاً فعال شده است.', 'success');
      if (pushEnableBtn) {
        pushEnableBtn.textContent = 'اعلان‌ها فعال شد';
      }
      stopFallbackPolling();
    } else {
      startFallbackPolling();
    }

    heartbeat();
    window.setInterval(heartbeat, 60000);
  });
</script>
{% endblock %}
