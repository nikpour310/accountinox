{% extends 'base.html' %}

{% block meta_title %}گفت‌وگوی پشتیبانی | {{ site_settings.site_name|default:'Accountinox' }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block content %}
  <section class="mx-auto max-w-3xl py-2">
    {% if request.GET.rated == '1' %}
      <div class="alert alert-success mb-4">امتیاز شما ثبت شد. متشکریم.</div>
    {% endif %}

    <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">گفت‌وگو با پشتیبانی</h1>
        {% if contact %}
          <p class="text-xs text-slate-500">{{ contact.name }} - {{ contact.phone }}</p>
        {% endif %}
        {% if session_closed %}
          <p class="text-xs text-amber-700">این گفتگو بسته شده است.</p>
        {% endif %}
      </div>
      <a href="{% url 'support:chat' %}" class="btn btn-ghost w-full sm:w-auto">ویرایش اطلاعات</a>
    </div>

    <div class="card overflow-hidden">
      <div id="messages" class="h-[60vh] overflow-y-auto bg-slate-50 p-3 sm:h-[30rem] sm:p-5 space-y-3">
        {% if messages %}
          {% for message in messages %}
            <div class="flex {% if message.is_from_user %}justify-end{% else %}justify-start{% endif %}" data-message-id="{{ message.id }}">
              <div class="max-w-[88%] sm:max-w-[72%]">
                <p class="mb-1 text-[11px] text-slate-500 {% if message.is_from_user %}text-left{% else %}text-right{% endif %}">
                  {{ message.name }} - {{ message.created_at|date:'H:i' }}
                </p>
                <div class="rounded-2xl px-4 py-2 text-sm leading-relaxed break-words {% if message.is_from_user %}bg-slate-900 text-white rounded-br-sm{% else %}bg-white border border-slate-200 text-slate-900 rounded-bl-sm{% endif %}">
                  {{ message.message }}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div id="empty-message" class="py-10 text-center text-sm text-slate-500">هنوز پیامی ارسال نشده است.</div>
        {% endif %}
      </div>

      <div class="border-t border-slate-200 bg-white p-3 sm:p-4 space-y-3">
        {% if session_closed %}
          {% if session_rating %}
            <div class="alert alert-success">امتیاز ثبت‌شده: {{ session_rating.score }} از 5</div>
          {% elif can_rate %}
            <div class="alert alert-info">
              گفت‌وگو بسته شده است.
              <a class="font-semibold underline" href="{% url 'support:rate_session' session.id %}">ثبت امتیاز اپراتور</a>
            </div>
          {% else %}
            <div class="alert">این گفت‌وگو بسته شده است. برای شروع گفت‌وگوی جدید به صفحه پشتیبانی برگردید.</div>
          {% endif %}
          <a href="{% url 'support:chat' %}" class="btn btn-primary w-full sm:w-auto">شروع گفت‌وگوی جدید</a>
        {% else %}
          <form id="user-message-form" class="space-y-3">
            <input id="session-id-input" type="hidden" name="session_id" value="{{ session.id }}">
            <label for="user-message-input" class="sr-only">پیام</label>
            <textarea
              id="user-message-input"
              name="message"
              rows="3"
              maxlength="500"
              class="form-input"
              placeholder="پیام خود را بنویسید..."
              required
            ></textarea>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <p class="text-xs text-slate-500">حداکثر 500 کاراکتر</p>
              <button type="submit" class="btn btn-primary w-full sm:w-auto">ارسال پیام</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messagesDiv = document.getElementById('messages');
      const form = document.getElementById('user-message-form');
      if (!messagesDiv) {
        return;
      }

      const emptyMessage = document.getElementById('empty-message');
      const messageInput = document.getElementById('user-message-input');
      const sessionIdInput = document.getElementById('session-id-input');
      const sessionClosed = {{ session_closed|yesno:"true,false" }};
      let currentSessionId = Number(sessionIdInput ? sessionIdInput.value : {{ session.id }});
      let isPolling = false;

      const getLastMessageId = function() {
        const messageElements = messagesDiv.querySelectorAll('[data-message-id]');
        if (!messageElements.length) {
          return 0;
        }
        return Number(messageElements[messageElements.length - 1].getAttribute('data-message-id') || 0);
      };

      let lastId = getLastMessageId();

      const scrollToBottom = function() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      };
      scrollToBottom();

      const appendMessage = function(message) {
        if (emptyMessage) {
          emptyMessage.remove();
        }
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${message.is_from_user ? 'justify-end' : 'justify-start'}`;
        wrapper.dataset.messageId = String(message.id);

        const bubbleWrap = document.createElement('div');
        bubbleWrap.className = 'max-w-[88%] sm:max-w-[72%]';

        const meta = document.createElement('p');
        meta.className = 'mb-1 text-[11px] text-slate-500';
        meta.style.textAlign = message.is_from_user ? 'left' : 'right';
        const formattedTime = new Date(message.created_at).toLocaleTimeString('fa-IR', {
          hour: '2-digit',
          minute: '2-digit',
        });
        meta.textContent = `${message.name || 'کاربر'} - ${formattedTime}`;

        const bubble = document.createElement('div');
        bubble.className = `rounded-2xl px-4 py-2 text-sm leading-relaxed break-words ${
          message.is_from_user
            ? 'bg-slate-900 text-white rounded-br-sm'
            : 'bg-white border border-slate-200 text-slate-900 rounded-bl-sm'
        }`;
        bubble.textContent = message.message || '';

        bubbleWrap.appendChild(meta);
        bubbleWrap.appendChild(bubble);
        wrapper.appendChild(bubbleWrap);
        messagesDiv.appendChild(wrapper);
        scrollToBottom();
      };

      const pollMessages = async function() {
        if (sessionClosed) {
          return;
        }
        if (isPolling || !currentSessionId) {
          window.setTimeout(pollMessages, 2500);
          return;
        }
        isPolling = true;
        try {
          const response = await fetch(`/support/poll/?thread_id=${currentSessionId}&since=${lastId}&timeout=10`, {
            credentials: 'same-origin',
          });
          if (!response.ok) {
            throw new Error('poll failed');
          }
          const data = await response.json();
          if (Array.isArray(data.messages) && data.messages.length > 0) {
            data.messages.forEach(function(msg) {
              appendMessage(msg);
              lastId = Math.max(lastId, Number(msg.id || 0));
            });
          }
        } catch (_) {
        } finally {
          isPolling = false;
          window.setTimeout(pollMessages, 2500);
        }
      };

      if (form && messageInput) {
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          const text = messageInput.value.trim();
          if (!text || !currentSessionId) {
            return;
          }
          const submitButton = form.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = true;
          }
          try {
            const response = await fetch('{% url "support:send_message" %}', {
              method: 'POST',
              body: new FormData(form),
              credentials: 'same-origin',
            });
            const data = await response.json().catch(function() {
              return {};
            });
            if (!response.ok || !data.ok) {
              throw new Error(data.error || 'send failed');
            }

            if (data.session_id && Number(data.session_id) !== currentSessionId) {
              currentSessionId = Number(data.session_id);
              if (sessionIdInput) {
                sessionIdInput.value = String(currentSessionId);
              }
              lastId = 0;
              messagesDiv.innerHTML = '';
            }

            messageInput.value = '';
            window.setTimeout(pollMessages, 200);
          } catch (_) {
            alert('ارسال پیام انجام نشد. دوباره تلاش کنید.');
          } finally {
            if (submitButton) {
              submitButton.disabled = false;
            }
          }
        });
      }

      if (!sessionClosed) {
        window.setTimeout(pollMessages, 1200);
      }
    });
  </script>
{% endblock %}

