{% extends 'base.html' %}

{% block meta_title %}تسویه حساب | {{ site_settings.site_name|default:'Accountinox' }}{% endblock %}
{% block meta_description %}تکمیل سفارش در {{ site_settings.site_name|default:'Accountinox' }} با پرداخت امن و مسیر ساده.{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}
{% block canonical %}<link rel="canonical" href="{{ site_base_url }}{% url 'shop:checkout' %}">{% endblock %}

{% block content %}
  <section class="mb-6 sm:mb-8">
    <h1 class="section-title">تسویه حساب</h1>
    <p class="mt-2 text-sm text-slate-600">در سه مرحله کوتاه سفارش را نهایی کنید.</p>
    <ol class="mt-4 grid grid-cols-1 gap-2 text-sm sm:grid-cols-3">
      <li class="card p-3 font-semibold text-slate-900">1. اطلاعات تماس</li>
      <li class="card p-3 font-semibold text-slate-900">2. آدرس</li>
      <li class="card p-3 font-semibold text-slate-900">3. پرداخت</li>
    </ol>
  </section>

  {% if cart_lines %}
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
      <section class="lg:col-span-2">
        <form method="post" action="{% url 'shop:checkout' %}" class="card p-4 sm:p-6">
          {% csrf_token %}

          <fieldset>
            <legend class="text-base font-bold text-slate-900">اطلاعات تماس</legend>
            <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div class="sm:col-span-2">
                <label for="full_name" class="mb-1 block text-sm text-slate-700">نام تحویل‌گیرنده</label>
                <input id="full_name" name="full_name" type="text" class="form-input" value="{{ checkout_data.full_name|default:'' }}" required>
                {% if form_errors.full_name %}<p class="mt-1 text-xs text-red-700">{{ form_errors.full_name }}</p>{% endif %}
              </div>
              <div>
                <label for="phone" class="mb-1 block text-sm text-slate-700">شماره موبایل</label>
                <input id="phone" name="phone" type="tel" class="form-input" value="{{ checkout_data.phone|default:'' }}" required>
                {% if form_errors.phone %}<p class="mt-1 text-xs text-red-700">{{ form_errors.phone }}</p>{% endif %}
              </div>
              <div>
                <label for="email" class="mb-1 block text-sm text-slate-700">ایمیل (اختیاری)</label>
                <input id="email" name="email" type="email" class="form-input" value="{{ checkout_data.email|default:'' }}">
              </div>
            </div>
          </fieldset>

          <fieldset class="mt-5">
            <legend class="text-base font-bold text-slate-900">آدرس</legend>
            {% if addresses %}
              <label for="address_id" class="mb-1 mt-3 block text-sm text-slate-700">انتخاب از نشانی‌های ذخیره‌شده</label>
              <select id="address_id" name="address_id" class="form-input">
                <option value="">انتخاب دستی</option>
                {% for address in addresses %}
                  <option value="{{ address.id }}" {% if checkout_data.address_id|stringformat:'s' == address.id|stringformat:'s' %}selected{% endif %}>
                    {{ address.full_name }} - {{ address.province }}، {{ address.city }}{% if address.is_default %} (پیش‌فرض){% endif %}
                  </option>
                {% endfor %}
              </select>
            {% endif %}

            <label for="address_text" class="mb-1 mt-3 block text-sm text-slate-700">آدرس کامل تحویل</label>
            <textarea id="address_text" name="address_text" rows="3" class="form-input" required>{{ checkout_data.address_text|default:'' }}</textarea>
            {% if form_errors.address_text %}<p class="mt-1 text-xs text-red-700">{{ form_errors.address_text }}</p>{% endif %}
          </fieldset>

          <fieldset class="mt-5">
            <legend class="text-base font-bold text-slate-900">روش پرداخت</legend>
            <div class="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
              <label class="card flex items-center gap-2 p-3">
                <input type="radio" name="gateway" value="zarinpal" {% if checkout_data.gateway != 'zibal' %}checked{% endif %}>
                <span class="text-sm text-slate-700">زرین‌پال</span>
              </label>
              <label class="card flex items-center gap-2 p-3">
                <input type="radio" name="gateway" value="zibal" {% if checkout_data.gateway == 'zibal' %}checked{% endif %}>
                <span class="text-sm text-slate-700">زیبال</span>
              </label>
            </div>
          </fieldset>

          <div class="mt-6 flex flex-col gap-2 sm:flex-row">
            <button type="submit" class="btn btn-primary w-full sm:w-auto smooth-hover">پرداخت و ثبت سفارش</button>
            <a href="{% url 'shop:cart' %}" class="btn btn-ghost w-full sm:w-auto">بازگشت به سبد</a>
          </div>
          <p class="mt-3 text-xs text-slate-500">وضعیت سفارش در پنل کاربری با مراحل «درحال بررسی»، «تأیید شد» و «تحویل داده شد» قابل مشاهده است.</p>
        </form>
      </section>

      <aside class="card h-fit p-4 sm:p-5">
        <h2 class="text-lg font-bold text-slate-900">خلاصه سفارش</h2>
        <ul class="mt-3 space-y-2 text-sm text-slate-700">
          {% for line in cart_lines %}
            <li class="flex items-center justify-between gap-2 border-b border-slate-100 pb-2">
              <span class="truncate">{{ line.product.title }} × {{ line.quantity }}</span>
              <strong>{{ line.line_total|floatformat:0 }}</strong>
            </li>
          {% endfor %}
        </ul>
        <dl class="mt-4 space-y-2 text-sm text-slate-700">
          <div class="flex items-center justify-between">
            <dt>تعداد آیتم‌ها</dt>
            <dd>{{ total_quantity }}</dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>جمع جزء</dt>
            <dd>{{ subtotal|floatformat:0 }} تومان</dd>
          </div>
          <div class="flex items-center justify-between border-t border-slate-200 pt-2 text-base font-bold text-slate-900">
            <dt>مبلغ پرداخت</dt>
            <dd>{{ final_total|floatformat:0 }} تومان</dd>
          </div>
        </dl>
      </aside>
    </div>
  {% else %}
      <div class="card p-8 text-center">
      <h2 class="text-xl font-bold text-slate-900">سبد خرید خالی است</h2>
      <p class="mt-2 text-sm text-slate-600">برای تسویه حساب ابتدا محصولی به سبد اضافه کنید.</p>
      <a href="{% url 'shop:product_list' %}" class="btn btn-primary mt-4 smooth-hover">مشاهده محصولات</a>
    </div>
  {% endif %}
{% endblock %}
