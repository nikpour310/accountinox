{% extends 'base.html' %}

{% block meta_title %}سبد خرید | {{ site_settings.site_name|default:'Accountinox' }}{% endblock %}
{% block meta_description %}سبد خرید شما در {{ site_settings.site_name|default:'Accountinox' }}. بررسی آیتم‌ها و ادامه به پرداخت امن.{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}
{% block canonical %}<link rel="canonical" href="{{ site_base_url }}{% url 'shop:cart' %}">{% endblock %}

{% block content %}
  <section class="mb-6 sm:mb-8">
    <h1 class="section-title">سبد خرید</h1>
    <p class="mt-2 text-sm text-slate-600">آیتم‌ها را بررسی کنید و سپس به پرداخت امن بروید.</p>
  </section>

  {% if cart_lines %}
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
      <section class="lg:col-span-2">
        <form method="post" action="{% url 'shop:cart_update' %}" class="space-y-3">
          {% csrf_token %}
          {% for line in cart_lines %}
            <article class="card p-4 sm:p-5">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="min-w-0">
                  <h2 class="truncate text-base font-bold text-slate-900 sm:text-lg">{{ line.product.title }}</h2>
                  <p class="text-sm text-slate-600">{{ line.product.price|floatformat:0 }} تومان</p>
                </div>
                <div class="flex items-center gap-2">
                  <label for="qty_{{ line.product.id }}" class="text-sm text-slate-600">تعداد</label>
                  <input
                    id="qty_{{ line.product.id }}"
                    name="qty_{{ line.product.id }}"
                    type="number"
                    min="0"
                    max="10"
                    value="{{ line.quantity }}"
                    class="form-input w-24"
                    aria-label="تعداد محصول {{ line.product.title }}"
                  >
                </div>
              </div>
              <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <p class="text-sm text-slate-700">جمع این آیتم: <strong>{{ line.line_total|floatformat:0 }} تومان</strong></p>
                <button type="submit" name="remove_id" value="{{ line.product.id }}" class="btn btn-ghost text-xs">حذف آیتم</button>
              </div>
            </article>
          {% endfor %}
          <button type="submit" class="btn btn-ghost w-full sm:w-auto">به‌روزرسانی سبد</button>
        </form>
      </section>

      <aside class="card h-fit p-4 sm:p-5">
        <h2 class="text-lg font-bold text-slate-900">خلاصه سفارش</h2>
        <dl class="mt-4 space-y-2 text-sm text-slate-700">
          <div class="flex items-center justify-between">
            <dt>تعداد آیتم‌ها</dt>
            <dd>{{ total_quantity }}</dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>جمع جزء</dt>
            <dd>{{ subtotal|floatformat:0 }} تومان</dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>هزینه ارسال</dt>
            <dd>محاسبه پس از تایید</dd>
          </div>
          <div class="flex items-center justify-between border-t border-slate-200 pt-2 text-base font-bold text-slate-900">
            <dt>مبلغ قابل پرداخت</dt>
            <dd>{{ final_total|floatformat:0 }} تومان</dd>
          </div>
        </dl>
        <a href="{% url 'shop:checkout' %}" class="btn btn-primary mt-5 w-full">ادامه به پرداخت</a>
        <p class="mt-3 text-xs text-slate-500">پس از پرداخت، وضعیت سفارش در پنل کاربری قابل پیگیری است.</p>
      </aside>
    </div>
  {% else %}
    <div class="card p-8 text-center">
      <h2 class="text-xl font-bold text-slate-900">سبد خرید شما خالی است</h2>
      <p class="mt-2 text-sm text-slate-600">برای شروع، محصولات فروشگاه را مشاهده کنید.</p>
      <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:justify-center">
        <a href="{% url 'shop:product_list' %}" class="btn btn-primary">مشاهده محصولات</a>
        <a href="{% url 'support:chat' %}" class="btn btn-ghost">نیاز به راهنمایی دارم</a>
      </div>
    </div>
  {% endif %}
{% endblock %}
