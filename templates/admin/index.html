{% extends "admin/base_site.html" %}
{% load i18n static log %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static "admin/css/dashboard.css" %}">
{% endblock %}

{% block coltype %}colMS{% endblock %}
{% block bodyclass %}{{ block.super }} dashboard{% endblock %}
{% block nav-breadcrumbs %}{% endblock %}
{% block nav-sidebar %}{% endblock %}

{% block content %}
<section class="admin-overview-card">
  <h2>داشبورد عملیات</h2>
  <p>Workspace مناسب را انتخاب کنید تا مهم‌ترین کارها را در ۱ تا ۲ کلیک انجام دهید.</p>
</section>

<section class="admin-role-priority" aria-label="اقدام‌های اولویت‌دار نقش">
  <div class="admin-section-head">
    <h2>اقدام‌های سریع شما</h2>
    <p>بر اساس سطح دسترسی فعلی شما نمایش داده می‌شود.</p>
  </div>
  <div class="admin-workspace-actions admin-role-priority-links">
    {% if admin_primary_role == 'support' %}
      {% if perms.support.view_chatsession %}
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1&has_unread=yes">صندوق خوانده‌نشده</a>
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1">جلسات فعال</a>
      {% endif %}
      {% if perms.support.view_supportcontact %}
        <a href="{% url 'admin:support_supportcontact_changelist' %}">مخاطبین پشتیبانی</a>
      {% endif %}
      {% if perms.support.view_supportrating %}
        <a href="{% url 'admin:support_supportrating_changelist' %}">امتیازها</a>
      {% endif %}
    {% elif admin_primary_role == 'crm' %}
      {% if perms.support.view_supportcontact %}
        <a href="{% url 'admin:support_supportcontact_changelist' %}">لیست مخاطبین</a>
      {% endif %}
      {% if perms.support.can_export_support_contacts %}
        <a href="{% url 'admin:support_supportcontact_export_filtered' %}">خروجی فیلترشده</a>
      {% endif %}
      {% if perms.support.view_chatsession %}
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1&assigned_to__isnull=True">جلسات بدون اپراتور</a>
      {% endif %}
    {% elif admin_primary_role == 'content' %}
      {% if perms.blog.view_post %}
        <a href="{% url 'admin:blog_post_changelist' %}?published__exact=0">پیش‌نویس‌ها</a>
        <a href="{% url 'admin:blog_post_changelist' %}">همه پست‌ها</a>
      {% endif %}
      {% if perms.blog.add_post %}
        <a href="{% url 'admin:blog_post_add' %}">پست جدید</a>
      {% endif %}
    {% else %}
      {% if perms.support.view_chatsession %}
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1&has_unread=yes">صندوق پشتیبانی</a>
      {% endif %}
      {% if perms.shop.view_order %}
        <a href="{% url 'admin:shop_order_changelist' %}?paid__exact=0">سفارش‌های در انتظار</a>
      {% endif %}
      {% if perms.blog.view_post %}
        <a href="{% url 'admin:blog_post_changelist' %}?published__exact=0">پیش‌نویس بلاگ</a>
      {% endif %}
    {% endif %}
  </div>
</section>

<section
  class="admin-workspace-switcher"
  data-workspace-switcher
  data-default-workspace="{% if admin_primary_role == 'content' %}blog{% elif admin_primary_role == 'crm' or admin_primary_role == 'support' %}support{% elif admin_primary_role == 'owner' %}support{% else %}settings{% endif %}"
>
  <div class="admin-workspace-tabs" role="tablist" aria-label="انتخاب فضای کاری">
    <button type="button" class="admin-workspace-tab is-active" data-workspace-tab="support" role="tab" aria-selected="true">پشتیبانی</button>
    <button type="button" class="admin-workspace-tab" data-workspace-tab="orders" role="tab" aria-selected="false">سفارش‌ها</button>
    <button type="button" class="admin-workspace-tab" data-workspace-tab="products" role="tab" aria-selected="false">محصولات</button>
    <button type="button" class="admin-workspace-tab" data-workspace-tab="blog" role="tab" aria-selected="false">بلاگ</button>
    <button type="button" class="admin-workspace-tab" data-workspace-tab="settings" role="tab" aria-selected="false">تنظیمات</button>
  </div>

  <article class="admin-workspace-panel is-active" data-workspace-panel="support" role="tabpanel">
    <div class="admin-workspace-actions">
      {% if perms.support.view_chatsession %}
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1&has_unread=yes">صندوق خوانده‌نشده</a>
        <a href="{% url 'admin:support_chatsession_changelist' %}?is_active__exact=1&assigned_to__id__exact={{ user.id }}">گفتگوهای من</a>
        <a href="{% url 'admin:support_chatsession_changelist' %}">همه گفتگوها</a>
      {% endif %}
    </div>
    <div class="admin-workspace-counters">
      {% if perms.support.view_chatsession %}
        <div><span>جلسات فعال</span><strong>{{ admin_dashboard_stats.support_active_sessions|default:"-" }}</strong></div>
        <div><span>پیام خوانده‌نشده</span><strong>{{ admin_dashboard_stats.support_unread_messages|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.support.view_supportrating %}
        <div><span>میانگین امتیاز ۳۰ روز</span><strong>{{ admin_dashboard_stats.support_avg_rating_30d|default:"-" }}</strong></div>
      {% endif %}
    </div>
    <div class="admin-pinned-views" data-pinned-views data-pinned-scope="support"></div>
  </article>

  <article class="admin-workspace-panel" data-workspace-panel="orders" role="tabpanel" hidden>
    <div class="admin-workspace-actions">
      {% if perms.shop.view_order %}
        <a href="{% url 'admin:shop_order_changelist' %}?paid__exact=0">سفارش پرداخت‌نشده</a>
        <a href="{% url 'admin:shop_order_changelist' %}">همه سفارش‌ها</a>
      {% endif %}
      {% if perms.shop.view_transactionlog %}
        <a href="{% url 'admin:shop_transactionlog_changelist' %}?success__exact=0">تراکنش ناموفق</a>
      {% endif %}
    </div>
    <div class="admin-workspace-counters">
      {% if perms.shop.view_order %}
        <div><span>در انتظار پرداخت</span><strong>{{ admin_dashboard_stats.shop_pending_orders|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.shop.view_transactionlog %}
        <div><span>پرداخت ناموفق</span><strong>{{ admin_dashboard_stats.shop_failed_payments|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.shop.view_product %}
        <div><span>محصول ثبت‌شده</span><strong>{{ admin_dashboard_stats.shop_products_count|default:"-" }}</strong></div>
      {% endif %}
    </div>
    <div class="admin-pinned-views" data-pinned-views data-pinned-scope="orders"></div>
  </article>

  <article class="admin-workspace-panel" data-workspace-panel="products" role="tabpanel" hidden>
    <div class="admin-workspace-actions">
      {% if perms.shop.view_product %}
        <a href="{% url 'admin:shop_product_changelist' %}">لیست محصولات</a>
      {% endif %}
      {% if perms.shop.add_product %}
        <a href="{% url 'admin:shop_product_add' %}">افزودن محصول</a>
      {% endif %}
      {% if perms.shop.view_category %}
        <a href="{% url 'admin:shop_category_changelist' %}">دسته‌بندی‌ها</a>
      {% endif %}
    </div>
    <div class="admin-workspace-counters">
      {% if perms.shop.view_product %}
        <div><span>تعداد محصولات</span><strong>{{ admin_dashboard_stats.shop_products_count|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.shop.view_order %}
        <div><span>سفارش پرداخت‌نشده</span><strong>{{ admin_dashboard_stats.shop_pending_orders|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.shop.view_transactionlog %}
        <div><span>تراکنش ناموفق</span><strong>{{ admin_dashboard_stats.shop_failed_payments|default:"-" }}</strong></div>
      {% endif %}
    </div>
    <div class="admin-pinned-views" data-pinned-views data-pinned-scope="products"></div>
  </article>

  <article class="admin-workspace-panel" data-workspace-panel="blog" role="tabpanel" hidden>
    <div class="admin-workspace-actions">
      {% if perms.blog.view_post %}
        <a href="{% url 'admin:blog_post_changelist' %}?published__exact=0">پیش‌نویس‌ها</a>
        <a href="{% url 'admin:blog_post_changelist' %}">همه پست‌ها</a>
      {% endif %}
      {% if perms.blog.add_post %}
        <a href="{% url 'admin:blog_post_add' %}">پست جدید</a>
      {% endif %}
    </div>
    <div class="admin-workspace-counters">
      {% if perms.blog.view_post %}
        <div><span>پیش‌نویس</span><strong>{{ admin_dashboard_stats.blog_draft_posts|default:"-" }}</strong></div>
        <div><span>کل پست‌ها</span><strong>{{ admin_dashboard_stats.blog_total_posts|default:"-" }}</strong></div>
      {% endif %}
      {% if perms.blog.view_postfaq %}
        <div><span>FAQ بلاگ</span><strong>{{ admin_dashboard_stats.blog_faq_count|default:"-" }}</strong></div>
      {% endif %}
    </div>
    <div class="admin-pinned-views" data-pinned-views data-pinned-scope="blog"></div>
  </article>

  <article class="admin-workspace-panel" data-workspace-panel="settings" role="tabpanel" hidden>
    <div class="admin-workspace-actions">
      {% if perms.core.view_sitesettings %}
        <a href="{% url 'admin:core_sitesettings_changelist' %}">تنظیمات سایت</a>
      {% endif %}
      {% if perms.auth.view_user %}
        <a href="{% url 'admin:auth_user_changelist' %}">کاربران</a>
      {% endif %}
      {% if perms.auth.view_group %}
        <a href="{% url 'admin:auth_group_changelist' %}">گروه‌ها</a>
      {% endif %}
    </div>
    <div class="admin-workspace-counters">
      <div><span>جلسات فعال پشتیبانی</span><strong>{{ admin_dashboard_stats.support_active_sessions|default:"-" }}</strong></div>
      <div><span>سفارش در انتظار</span><strong>{{ admin_dashboard_stats.shop_pending_orders|default:"-" }}</strong></div>
      <div><span>پیش‌نویس بلاگ</span><strong>{{ admin_dashboard_stats.blog_draft_posts|default:"-" }}</strong></div>
    </div>
    <div class="admin-pinned-views" data-pinned-views data-pinned-scope="settings"></div>
  </article>
</section>

<section class="admin-favorites-panel" aria-label="ادامه کار">
  <div class="admin-section-head">
    <h2>ادامه از آخرین صفحات</h2>
    <p>آخرین ۵ صفحه‌ای که در پنل مدیریت باز کرده‌اید.</p>
  </div>
  <div class="admin-recent-list" data-recent-admin-list aria-live="polite"></div>
</section>

<section class="admin-favorites-panel" aria-label="علاقه‌مندی‌ها">
  <div class="admin-section-head">
    <h2>علاقه‌مندی‌ها</h2>
    <p>مدل‌های پرکاربرد را ستاره‌دار کنید تا همیشه در دسترس باشند.</p>
  </div>
  <div class="admin-favorites-list" data-favorites-list aria-live="polite"></div>
  <noscript>
    <ul class="admin-favorites-noscript">
      {% for item in admin_default_favorites %}
        <li><a href="{{ item.url }}">{{ item.label }}</a></li>
      {% endfor %}
    </ul>
  </noscript>
</section>

<div id="content-main" class="app-list">
  {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
</div>
{% endblock %}

{% block sidebar %}
<div id="content-related">
  <div class="module" id="recent-actions-module">
    <h2>{% translate 'Recent actions' %}</h2>
    <h3>{% translate 'My actions' %}</h3>
    {% get_admin_log 10 as admin_log for_user user %}
    {% if not admin_log %}
      <p>{% translate 'None available' %}</p>
    {% else %}
      <ul class="actionlist">
        {% for entry in admin_log %}
          <li class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %}changelink{% endif %}{% if entry.is_deletion %}deletelink{% endif %}">
            <span class="visually-hidden">
              {% if entry.is_addition %}{% translate 'Added:' %}
              {% elif entry.is_change %}{% translate 'Changed:' %}
              {% elif entry.is_deletion %}{% translate 'Deleted:' %}{% endif %}
            </span>
            {% if entry.is_deletion or not entry.get_admin_url %}
              {{ entry.object_repr }}
            {% else %}
              <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
            {% endif %}
            <br>
            {% if entry.content_type %}
              <span class="mini quiet">{% filter capfirst %}{{ entry.content_type.name }}{% endfilter %}</span>
            {% else %}
              <span class="mini quiet">{% translate 'Unknown content' %}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>
{% endblock %}
