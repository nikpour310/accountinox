{% extends 'base.html' %}

{% block meta_title %}جزئیات سفارش #{{ order.id }} | {{ site_settings.site_name|default:'Accountinox' }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block content %}
  <section class="mx-auto max-w-5xl">
    <h1 class="mb-4 text-2xl font-bold text-slate-900 sm:text-3xl">جزئیات سفارش #{{ order.id }}</h1>
    {% include 'accounts/_nav.html' %}

    <div class="grid grid-cols-1 gap-5 lg:grid-cols-3">
      <article class="card p-4 lg:col-span-2">
        <h2 class="text-base font-bold text-slate-900">وضعیت سفارش</h2>
        <ol class="mt-3 space-y-2">
          {% for step in order.timeline_steps %}
            <li class="rounded-lg border px-3 py-2 text-sm {% if step.state == 'current' %}border-blue-300 bg-blue-50{% elif step.state == 'done' %}border-green-300 bg-green-50{% else %}border-slate-200 bg-white{% endif %}">
              {{ step.label }}
            </li>
          {% endfor %}
        </ol>
        <p class="mt-3 text-sm text-slate-700">آخرین وضعیت: <strong>{{ order.get_status_display }}</strong></p>

        <h3 class="mt-6 text-base font-bold text-slate-900">آیتم‌های سفارش</h3>
        <ul class="mt-3 space-y-2">
          {% for item in order.items.all %}
            <li class="rounded-lg border border-slate-200 p-3 text-sm text-slate-700">
              <p class="font-semibold text-slate-900">{{ item.product.title|default:'محصول حذف شده' }}</p>
              <p>قیمت: {{ item.price|floatformat:0 }} تومان</p>
              <p>وضعیت تحویل: {% if item.account_item %}تحویل شد{% else %}در انتظار بررسی{% endif %}</p>
            </li>
          {% endfor %}
        </ul>
      </article>

      <aside class="card h-fit p-4">
        <h2 class="text-base font-bold text-slate-900">اطلاعات سفارش</h2>
        <dl class="mt-3 space-y-2 text-sm text-slate-700">
          <div><dt class="font-semibold">تاریخ</dt><dd>{{ order.created_at|date:'Y/m/d H:i' }}</dd></div>
          <div><dt class="font-semibold">مبلغ کل</dt><dd>{{ order.total|floatformat:0 }} تومان</dd></div>
          <div><dt class="font-semibold">نام</dt><dd>{{ order.customer_name|default:'-' }}</dd></div>
          <div><dt class="font-semibold">موبایل</dt><dd>{{ order.customer_phone|default:'-' }}</dd></div>
          <div><dt class="font-semibold">ایمیل</dt><dd>{{ order.customer_email|default:'-' }}</dd></div>
          <div><dt class="font-semibold">آدرس</dt><dd>{{ order.shipping_address|default:'-' }}</dd></div>
        </dl>
      </aside>
    </div>

    <section class="card mt-5 p-4">
      <h2 class="text-base font-bold text-slate-900">رسیدها / تراکنش‌ها</h2>
      {% if transactions %}
        <ul class="mt-3 space-y-2 text-sm">
          {% for tx in transactions %}
            <li class="rounded-lg border border-slate-200 p-3">
              <p class="font-semibold text-slate-900">تراکنش #{{ tx.id }} - {{ tx.provider }}</p>
              <p class="text-slate-600">زمان: {{ tx.created_at|date:'Y/m/d H:i' }}</p>
              <p class="text-slate-600">وضعیت: {% if tx.success %}موفق{% else %}ناموفق{% endif %}</p>
              <p class="text-slate-600">مرجع: {{ tx.payload.reference|default:'-' }}</p>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="mt-3 text-sm text-slate-600">تراکنشی برای این سفارش ثبت نشده است.</p>
      {% endif %}
    </section>
  </section>
{% endblock %}

