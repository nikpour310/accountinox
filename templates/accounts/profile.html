{% extends 'base.html' %}
{% load static %}

{% block title %}ویرایش پروفایل | {{ block.super }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">

    {# ── Sidebar ── #}
    {% include "accounts/_panel_layout.html" with active_page='profile' %}

    {# ── Main Content ── #}
    <div class="lg:col-span-9 xl:col-span-9 min-w-0 space-y-6">

      {# ── Page Header ── #}
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-gray-900">ویرایش پروفایل</h1>
          <p class="text-sm text-gray-500 mt-1">اطلاعات شخصی خود را مدیریت و به‌روزرسانی کنید</p>
        </div>
      </div>

      {# Personal Info — first_name / last_name (normal form) #}
      <form method="post" x-data="{ changed: false }" @input="changed = true">
        {% csrf_token %}

        <div class="card overflow-hidden reveal">
          <div class="px-6 py-5 border-b border-gray-100 flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-primary-50 text-primary-600 flex items-center justify-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            </div>
            <div>
              <h2 class="font-semibold text-gray-900">اطلاعات شخصی</h2>
              <p class="text-xs text-gray-500">نام و نام خانوادگی</p>
            </div>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
              <div>
                <label for="{{ form.first_name.id_for_label }}" class="form-label flex items-center gap-1.5">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                  نام
                </label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<p class="mt-1.5 text-xs text-red-600">{{ form.first_name.errors|striptags }}</p>{% endif %}
              </div>
              <div>
                <label for="{{ form.last_name.id_for_label }}" class="form-label flex items-center gap-1.5">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                  نام خانوادگی
                </label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<p class="mt-1.5 text-xs text-red-600">{{ form.last_name.errors|striptags }}</p>{% endif %}
              </div>
            </div>
          </div>
        </div>

        {# Submit for personal info #}
        <div class="flex items-center justify-between mt-6 reveal">
          <p class="text-xs text-gray-400" x-show="changed" x-transition>تغییرات ذخیره نشده دارید</p>
          <div class="flex gap-3 ms-auto">
            <a href="{% url 'accounts:dashboard' %}" class="btn btn-ghost">انصراف</a>
            <button type="submit" class="btn btn-primary">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              ذخیره تغییرات
            </button>
          </div>
        </div>
      </form>

      {# Contact Info — Phone & Email (AJAX verification) #}
      <div class="card overflow-hidden reveal" x-data="profileVerify()">
        <div class="px-6 py-5 border-b border-gray-100 flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-violet-50 text-violet-600 flex items-center justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <div>
            <h2 class="font-semibold text-gray-900">اطلاعات تماس</h2>
            <p class="text-xs text-gray-500">تغییر ایمیل و شماره موبایل نیاز به تایید دارد</p>
          </div>
        </div>
        <div class="p-6 space-y-6">

          {# ── Phone ── #}
          <div class="p-4 bg-gray-50 rounded-xl space-y-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                </div>
                <div>
                  <p class="text-xs text-gray-500">شماره موبایل</p>
                  <p class="text-sm font-medium text-gray-900 tracking-wide" x-text="phoneDisplay">{{ profile.phone|default:'ثبت نشده' }}</p>
                </div>
              </div>
              <button type="button"
                      class="btn btn-ghost btn-sm whitespace-nowrap"
                      x-show="phoneStep === 'idle'"
                      @click="phoneStep = 'input'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                تغییر
              </button>
            </div>

            {# Step 1: enter new phone #}
            <div x-show="phoneStep === 'input'" x-transition class="space-y-3">
              <div class="flex gap-2">
                <input type="tel" x-model="newPhone"
                       placeholder="09xxxxxxxxx" dir="ltr"
                       class="ui-input flex-1 text-sm" maxlength="11">
                <button type="button" class="btn btn-primary btn-sm whitespace-nowrap"
                        :disabled="phoneBusy"
                        @click="sendPhoneCode()">
                  <template x-if="phoneBusy"><span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span></template>
                  <template x-if="!phoneBusy">
                    <span>ارسال کد</span>
                  </template>
                </button>
                <button type="button" class="btn btn-ghost btn-sm" @click="resetPhone()">انصراف</button>
              </div>
              <p x-show="phoneError" x-text="phoneError" class="text-xs text-red-600"></p>
            </div>

            {# Step 2: enter verification code #}
            <div x-show="phoneStep === 'verify'" x-transition class="space-y-3">
              <p class="text-xs text-gray-600">
                کد تایید به شماره <span class="font-mono font-semibold" x-text="newPhone" dir="ltr"></span> ارسال شد.
              </p>
              <div class="flex gap-2">
                <input type="text" x-model="phoneCode"
                       placeholder="کد ۶ رقمی" dir="ltr" inputmode="numeric"
                       class="ui-input flex-1 text-sm tracking-[0.3em] text-center" maxlength="6">
                <button type="button" class="btn btn-primary btn-sm whitespace-nowrap"
                        :disabled="phoneBusy"
                        @click="verifyPhoneCode()">
                  تایید
                </button>
                <button type="button" class="btn btn-ghost btn-sm" @click="resetPhone()">انصراف</button>
              </div>
              <p x-show="phoneError" x-text="phoneError" class="text-xs text-red-600"></p>
              <p x-show="phoneTimer > 0" class="text-xs text-gray-400">
                ارسال مجدد تا <span x-text="phoneTimer" class="font-mono"></span> ثانیه
              </p>
              <button type="button"
                      class="text-xs text-primary-600 hover:underline"
                      x-show="phoneTimer <= 0 && phoneStep === 'verify'"
                      @click="sendPhoneCode()">
                ارسال مجدد کد
              </button>
            </div>

            {# Step 3: success #}
            <div x-show="phoneStep === 'done'" x-transition>
              <p class="text-xs text-emerald-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                شماره موبایل با موفقیت تغییر کرد
              </p>
            </div>
          </div>

          {# ── Email ── #}
          <div class="p-4 bg-gray-50 rounded-xl space-y-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <div>
                  <p class="text-xs text-gray-500">ایمیل</p>
                  <p class="text-sm font-medium text-gray-900" x-text="emailDisplay">{{ user.email|default:'ثبت نشده' }}</p>
                </div>
              </div>
              <button type="button"
                      class="btn btn-ghost btn-sm whitespace-nowrap"
                      x-show="emailStep === 'idle'"
                      @click="emailStep = 'input'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                تغییر
              </button>
            </div>

            {# Step 1: enter new email #}
            <div x-show="emailStep === 'input'" x-transition class="space-y-3">
              <div class="flex gap-2">
                <input type="email" x-model="newEmail"
                       placeholder="email@example.com" dir="ltr"
                       class="ui-input flex-1 text-sm">
                <button type="button" class="btn btn-primary btn-sm whitespace-nowrap"
                        :disabled="emailBusy"
                        @click="sendEmailCode()">
                  <template x-if="emailBusy"><span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span></template>
                  <template x-if="!emailBusy">
                    <span>ارسال کد</span>
                  </template>
                </button>
                <button type="button" class="btn btn-ghost btn-sm" @click="resetEmail()">انصراف</button>
              </div>
              <p x-show="emailError" x-text="emailError" class="text-xs text-red-600"></p>
            </div>

            {# Step 2: enter verification code #}
            <div x-show="emailStep === 'verify'" x-transition class="space-y-3">
              <p class="text-xs text-gray-600">
                کد تایید به آدرس <span class="font-mono font-semibold" x-text="newEmail" dir="ltr"></span> ارسال شد.
              </p>
              <div class="flex gap-2">
                <input type="text" x-model="emailCode"
                       placeholder="کد ۶ رقمی" dir="ltr" inputmode="numeric"
                       class="ui-input flex-1 text-sm tracking-[0.3em] text-center" maxlength="6">
                <button type="button" class="btn btn-primary btn-sm whitespace-nowrap"
                        :disabled="emailBusy"
                        @click="verifyEmailCode()">
                  تایید
                </button>
                <button type="button" class="btn btn-ghost btn-sm" @click="resetEmail()">انصراف</button>
              </div>
              <p x-show="emailError" x-text="emailError" class="text-xs text-red-600"></p>
              <p x-show="emailTimer > 0" class="text-xs text-gray-400">
                ارسال مجدد تا <span x-text="emailTimer" class="font-mono"></span> ثانیه
              </p>
              <button type="button"
                      class="text-xs text-primary-600 hover:underline"
                      x-show="emailTimer <= 0 && emailStep === 'verify'"
                      @click="sendEmailCode()">
                ارسال مجدد کد
              </button>
            </div>

            {# Step 3: success #}
            <div x-show="emailStep === 'done'" x-transition>
              <p class="text-xs text-emerald-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                ایمیل با موفقیت تغییر کرد
              </p>
            </div>
          </div>

        </div>
      </div>

      {# Security Card #}
      <div class="card overflow-hidden reveal">
        <div class="px-6 py-5 border-b border-gray-100 flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
          </div>
          <div>
            <h2 class="font-semibold text-gray-900">امنیت حساب</h2>
            <p class="text-xs text-gray-500">رمز عبور و تنظیمات ورود</p>
          </div>
        </div>
        <div class="p-6">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 p-4 bg-gray-50 rounded-xl">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">رمز عبور</p>
                <p class="text-xs text-gray-500">برای امنیت بیشتر، رمز عبور خود را به‌صورت دوره‌ای تغییر دهید</p>
              </div>
            </div>
            <a href="{% url 'account_change_password' %}" class="btn btn-ghost btn-sm whitespace-nowrap">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
              تغییر رمز عبور
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function profileVerify() {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  return {
    /* ── Phone state ── */
    phoneStep: 'idle',        // idle → input → verify → done
    newPhone: '',
    phoneCode: '',
    phoneError: '',
    phoneBusy: false,
    phoneTimer: 0,
    phoneDisplay: '{{ profile.phone|default:"ثبت نشده" }}',
    _phoneInterval: null,

    /* ── Email state ── */
    emailStep: 'idle',
    newEmail: '',
    emailCode: '',
    emailError: '',
    emailBusy: false,
    emailTimer: 0,
    emailDisplay: '{{ user.email|default:"ثبت نشده" }}',
    _emailInterval: null,

    /* ── Phone methods ── */
    async sendPhoneCode() {
      this.phoneError = '';
      if (!/^09\d{9}$/.test(this.newPhone)) {
        this.phoneError = 'شماره موبایل معتبر نیست (مثلاً 09123456789)';
        return;
      }
      this.phoneBusy = true;
      try {
        const res = await fetch('{% url "accounts:send_phone_change_code" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify({phone: this.newPhone})
        });
        const data = await res.json();
        if (data.ok) {
          this.phoneStep = 'verify';
          this.startPhoneTimer(data.cooldown || 120);
        } else {
          this.phoneError = data.error || 'خطا در ارسال کد';
        }
      } catch {
        this.phoneError = 'خطای شبکه';
      } finally {
        this.phoneBusy = false;
      }
    },

    async verifyPhoneCode() {
      this.phoneError = '';
      if (this.phoneCode.length < 4) {
        this.phoneError = 'کد تایید را وارد کنید';
        return;
      }
      this.phoneBusy = true;
      try {
        const res = await fetch('{% url "accounts:verify_phone_change" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify({code: this.phoneCode})
        });
        const data = await res.json();
        if (data.ok) {
          this.phoneDisplay = data.new_value || this.newPhone;
          const navIdentity = data.username || this.phoneDisplay;
          document.querySelectorAll('[data-nav-identity]').forEach((el) => {
            el.textContent = navIdentity;
          });
          this.phoneStep = 'done';
          clearInterval(this._phoneInterval);
        } else {
          this.phoneError = data.error || 'کد نادرست است';
        }
      } catch {
        this.phoneError = 'خطای شبکه';
      } finally {
        this.phoneBusy = false;
      }
    },

    startPhoneTimer(seconds) {
      this.phoneTimer = seconds;
      clearInterval(this._phoneInterval);
      this._phoneInterval = setInterval(() => {
        this.phoneTimer--;
        if (this.phoneTimer <= 0) clearInterval(this._phoneInterval);
      }, 1000);
    },

    resetPhone() {
      this.phoneStep = 'idle';
      this.newPhone = '';
      this.phoneCode = '';
      this.phoneError = '';
      this.phoneTimer = 0;
      clearInterval(this._phoneInterval);
    },

    /* ── Email methods ── */
    async sendEmailCode() {
      this.emailError = '';
      if (!this.newEmail || !this.newEmail.includes('@')) {
        this.emailError = 'آدرس ایمیل معتبر نیست';
        return;
      }
      this.emailBusy = true;
      try {
        const res = await fetch('{% url "accounts:send_email_change_code" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify({email: this.newEmail})
        });
        const data = await res.json();
        if (data.ok) {
          this.emailStep = 'verify';
          this.startEmailTimer(data.cooldown || 120);
        } else {
          this.emailError = data.error || 'خطا در ارسال کد';
        }
      } catch {
        this.emailError = 'خطای شبکه';
      } finally {
        this.emailBusy = false;
      }
    },

    async verifyEmailCode() {
      this.emailError = '';
      if (this.emailCode.length < 4) {
        this.emailError = 'کد تایید را وارد کنید';
        return;
      }
      this.emailBusy = true;
      try {
        const res = await fetch('{% url "accounts:verify_email_change" %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
          body: JSON.stringify({code: this.emailCode})
        });
        const data = await res.json();
        if (data.ok) {
          this.emailDisplay = data.new_value || this.newEmail;
          document.querySelectorAll('[data-nav-email]').forEach((el) => {
            el.textContent = this.emailDisplay;
          });
          this.emailStep = 'done';
          clearInterval(this._emailInterval);
        } else {
          this.emailError = data.error || 'کد نادرست است';
        }
      } catch {
        this.emailError = 'خطای شبکه';
      } finally {
        this.emailBusy = false;
      }
    },

    startEmailTimer(seconds) {
      this.emailTimer = seconds;
      clearInterval(this._emailInterval);
      this._emailInterval = setInterval(() => {
        this.emailTimer--;
        if (this.emailTimer <= 0) clearInterval(this._emailInterval);
      }, 1000);
    },

    resetEmail() {
      this.emailStep = 'idle';
      this.newEmail = '';
      this.emailCode = '';
      this.emailError = '';
      this.emailTimer = 0;
      clearInterval(this._emailInterval);
    },
  };
}
</script>
{% endblock %}

